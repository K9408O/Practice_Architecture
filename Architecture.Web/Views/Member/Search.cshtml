@model Architecture.Common.DTO.SearchDto

<h2>會員查詢</h2>

<form id="searchForm">
    <!-- 查詢全部會員按鈕 -->
    <button id="btnLoadAll" class="btn btn-primary mt-3" type="button">查詢全部會員</button>
    <hr />

    <div>
        <label>手機：</label>
        <input type="text" id="Phone" name="Phone" maxlength="10" />
    </div>
    <button type="submit" class="btn btn-primary">查詢單筆</button>
</form>

<div id="searchResult" class="mt-3"></div>

<table class="table table-bordered table-hover mt-3">
    <thead>
        <tr>
            <th>姓名</th>
            <th>手機</th>
            <th>市話</th>
            <th>性別</th>
            <th>生日</th>
        </tr>
    </thead>
    <tbody id="allMembersBody">
        <!-- 這裡放動態生成的會員資料 -->
    </tbody>
</table>
<!-- ✅ Modal 用來編輯會員資料 -->
<!-- ✅ 編輯 Modal -->
<div class="modal fade" id="editModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="editForm">
                <div class="modal-header">
                    <h5 class="modal-title">編輯會員</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="editId">
                    <input type="text" class="form-control mb-2" id="editName" placeholder="姓名">
                    <input type="text" class="form-control mb-2" id="editPhone" placeholder="手機">
                    <input type="text" class="form-control mb-2" id="editTel" placeholder="市話">
                    <select class="form-select mb-2" id="editGender">
                        <option value="M">男</option>
                        <option value="F">女</option>
                    </select>
                    <input type="date" class="form-control" id="editBirthday">
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary">儲存</button>
                </div>
            </form>
        </div>
    </div>
</div>@section scripts {
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        (function () {
            const apiBase = 'https://localhost:44362'; // 改成你的 API URL

            $('#searchForm').on('submit', function (e) {
                e.preventDefault();
                const phone = $('#Phone').val().trim();
                console.log("送出的 Phone：", phone);
                $.ajax({
                    url: `${apiBase}/api/member/search`,
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({ phone: phone }),
                    success: function (member) {
                        console.log("✅ 接收到回傳資料", member);
                        if (!member) {
                            $('#searchResult').html('<div>查無此會員</div>').css('color', 'red');
                            return;
                        }

                        const birthdayText = member.birthday ? member.birthday.split('T')[0] : '無資料';

                        $('#searchResult').html(`
                            <div>姓名：${member.Name}</div>
                            <div>手機：${member.Phone}</div>
                            <div>市話：${member.Tel || ''}</div>
                            <div>性別：${member.Gender}</div>
                            <div>生日：${member.Birthday ? member.Birthday.split('T')[0] : '無資料'}</div>
                        `).css('color', 'black');
                    },
                    statusCode: {
                        404: function () {
                            // 當後端回 404 NotFound 時
                            $('#searchResult')
                                .html('<div>查無此會員</div>')
                                .css('color', 'red');
                        }
                    },
                    error: function (xhr) {
                        // 其他錯誤
                        if (xhr.status !== 404) {
                            alert('查詢失敗，請稍後再試');
                        }
                    }
                });
            });
        })();
        //搜尋全部
        $(function () {
            $('#btnLoadAll').click(function () {
                $.ajax({
                    url: 'https://localhost:44362/api/member/all', // ✅ API 地址
                    type: 'GET',
                    success: function (members) {
                        var rows = '';
                        if (members.length === 0) {
                            rows = '<tr><td colspan="5" class="text-center">目前沒有資料</td></tr>';
                        } else {
                            members.forEach(function (m) {
                                rows += `
                                            <tr data-id="${m.Id}"
                                            data-name="${m.Name}"
                                            data-phone="${m.Phone}"
                                            data-tel="${m.Tel}"
                                            data-gender="${m.Gender}"
                                            data-birthday="${m.Birthday ? m.Birthday.substring(0, 10) : ''}">
                                            <td>${m.Name}</td>
                                            <td>${m.Phone}</td>
                                            <td>${m.Tel || ''}</td>
                                            <td>${m.Gender}</td>
                                            <td>${m.Birthday ? m.Birthday.substring(0, 10) : ''}</td>
                                            <td>
                                                <button class="btn btn-sm btn-warning btn-edit">編輯</button>
                                                <button class="btn btn-sm btn-danger btn-delete">刪除</button>
                                            </td>
                                        </tr>`;
                            });
                        }
                        $('#allMembersBody').html(rows);
                    },
                    error: function () {
                        alert('載入失敗！');
                    }
                });
            });
        });
        //刪除
        $(document).on('click', '.btn-delete', function () {
            const $tr = $(this).closest('tr');
            const id = $tr.data('id');

            if (!confirm('確定要刪除這筆會員嗎？')) return;

            $.ajax({
                url: 'https://localhost:44362/api/member/delete',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ id: id }),
                success: function (res) {
                    alert(res.message || '刪除成功');
                    $tr.remove(); // 或重新載入
                },
                error: function (xhr) {
                    alert(xhr.responseJSON?.message || '刪除失敗');
                }
            });
        });
        //編輯
        $(function () {
            // 綁定按鈕，開啟 modal 並帶入資料
            $(document).on('click', '.btn-edit', function () {
                const $tr = $(this).closest('tr');
                $('#editId').val($tr.data('id'));
                $('#editName').val($tr.data('name'));
                $('#editPhone').val($tr.data('phone'));
                $('#editTel').val($tr.data('tel'));
                $('#editGender').val($tr.data('gender'));
                $('#editBirthday').val($tr.data('birthday'));

                const modal = new bootstrap.Modal(document.getElementById('editModal'));
                modal.show();
            });

            // 表單送出
            $('#editForm').on('submit', function (e) {
                e.preventDefault();
                const dto = {
                    id: $('#editId').val(),
                    name: $('#editName').val(),
                    phone: $('#editPhone').val(),
                    tel: $('#editTel').val(),
                    gender: $('#editGender').val(),
                    birthday: $('#editBirthday').val()
                };

                $.ajax({
                    url: 'https://localhost:44362/api/member/update',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(dto),
                    success: function (res) {
                        alert(res.message || '更新成功');
                        bootstrap.Modal.getInstance(document.getElementById('editModal')).hide();
                        // 若需要，這裡可以呼叫 $('#btnLoadAll').click();
                    },
                    error: function (xhr) {
                        alert(xhr.responseJSON?.message || '更新失敗');
                    }
                });
            });
        });
    </script>
}
